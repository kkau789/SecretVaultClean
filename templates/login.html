 <!DOCTYPE html>
<html>
<head>
    <title>Secret Vault</title>
</head>
<body>

<h2>Secret Vault üîê</h2>

<button onclick="register()">Register Fingerprint</button>
<button onclick="login()">Login with Fingerprint</button>

<p id="status"></p>

<script>
function bufferDecode(value) {
    return Uint8Array.from(atob(value), c => c.charCodeAt(0));
}

function bufferEncode(value) {
    return btoa(String.fromCharCode(...new Uint8Array(value)));
}

async function register() {
    document.getElementById("status").innerText = "Starting registration...";

    const response = await fetch("/register/begin");
    const options = await response.arrayBuffer();
    const publicKey = CBOR.decode(options);

    publicKey.challenge = bufferDecode(publicKey.challenge);
    publicKey.user.id = bufferDecode(publicKey.user.id);

    const credential = await navigator.credentials.create({ publicKey });

    const credentialData = {
        id: credential.id,
        rawId: bufferEncode(credential.rawId),
        response: {
            attestationObject: bufferEncode(credential.response.attestationObject),
            clientDataJSON: bufferEncode(credential.response.clientDataJSON)
        },
        type: credential.type
    };

    await fetch("/register/complete", {
        method: "POST",
        body: CBOR.encode(credentialData)
    });

    document.getElementById("status").innerText = "Fingerprint registered successfully!";
}

async function login() {
    document.getElementById("status").innerText = "Starting authentication...";

    const response = await fetch("/login/begin");
    const options = await response.arrayBuffer();
    const publicKey = CBOR.decode(options);

    publicKey.challenge = bufferDecode(publicKey.challenge);

    if (publicKey.allowCredentials) {
        publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
            ...cred,
            id: bufferDecode(cred.id)
        }));
    }

    const assertion = await navigator.credentials.get({ publicKey });

    const authData = {
        id: assertion.id,
        rawId: bufferEncode(assertion.rawId),
        response: {
            authenticatorData: bufferEncode(assertion.response.authenticatorData),
            clientDataJSON: bufferEncode(assertion.response.clientDataJSON),
            signature: bufferEncode(assertion.response.signature),
            userHandle: assertion.response.userHandle ? bufferEncode(assertion.response.userHandle) : null
        },
        type: assertion.type
    };

    await fetch("/login/complete", {
        method: "POST",
        body: CBOR.encode(authData)
    });

    window.location.href = "/";
}
</script>

<script src="https://cdn.jsdelivr.net/npm/cbor-js@0.1.0/cbor.js"></script>

</body>
</html>
