<!DOCTYPE html>
<html>
<head>
  <title>Secret Vault</title>
</head>
<body>
  <h1>üîê Secret Vault</h1>

  <button onclick="register()">Register Fingerprint</button>
  <button onclick="login()">Login with Fingerprint</button>

  <script>
    function bufferDecode(value) {
      return Uint8Array.from(atob(value), c => c.charCodeAt(0));
    }

    function bufferEncode(value) {
      return btoa(String.fromCharCode(...new Uint8Array(value)));
    }

    async function register() {
      const response = await fetch("/register/begin");
      const options = await response.json();

      options.challenge = bufferDecode(options.challenge);
      options.user.id = bufferDecode(options.user.id);

      const credential = await navigator.credentials.create({
        publicKey: options
      });

      await fetch("/register/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(credential)
      });

      alert("Registration successful!");
    }

    async function login() {
      const response = await fetch("/login/begin");
      const options = await response.json();

      options.challenge = bufferDecode(options.challenge);

      const assertion = await navigator.credentials.get({
        publicKey: options
      });

      await fetch("/login/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(assertion)
      });

      alert("Login successful!");
    }
  </script>
</body>
</html>
